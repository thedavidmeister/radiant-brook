<?php

namespace AppBundle\Tests\API\Bitstamp;

use GuzzleHttp\Client;
use Masterminds\HTML5;
use Symfony\Bundle\FrameworkBundle\Test\WebTestCase;

/**
 * Tests that the Bitstamp API documentation has not changed.
 */
class BitstampDocumentationTest extends WebTestCase
{
    const BITSTAMP_DOCUMENTATION_URL = 'https://www.bitstamp.net/api/';

    /**
     * Fetch and cache a response from the API documentation.
     *
     * @return GuzzleHttp\Psr7\Response
     */
    protected function response()
    {
        if (!isset($this->response)) {
            $client = new Client();
            $this->response = $client->get(self::BITSTAMP_DOCUMENTATION_URL);
        }

        return $this->response;
    }
    protected $response;

    /**
     * Tests that the API documentation is responding as 200.
     *
     * @group stable
     * @group slow
     *
     * @slowThreshold 5000
     */
    public function testStatusCode()
    {
        $this->assertEquals(200, $this->response()->getStatusCode());
    }

    /**
     * Tests that the expected and current body represents the same API docs.
     *
     * This does not actually run atm because of the fn name. @todo - fix it.
     *
     * @group slow
     *
     * @slowThreshold 5000
     */
    public function todoTestBody()
    {
        $current = $this->extractAPIDocumentation($this->response()->getBody());
        $hash = md5($current);
        // Hashes are easier to compare than big strings or arrays.
        $this->assertEquals($this->expectedExtractHash(), $hash, 'Hashes do not match. expected: ' . $this->expectedExtractHash() . ' actual: ' . $hash . ' full text: ' . $current);
    }

    /**
     * Given an HTML body, extracts the relevant API documentation text.
     *
     * @param mixed $html
     *   Anything that can be cast to a valid HTML string.
     *
     * @return string
     *   API documentation text string, without HTML.
     */
    protected function extractAPIDocumentation($html)
    {
        $html5 = new HTML5();
        $document = $html5->loadHTML((string) $html);

        $xpath = new \DomXPath($document);
        $class = 'content';
        $nodes = $xpath->query("//*[contains(concat(' ', normalize-space(@class), ' '), ' " . $class . " ')]");

        $text = $nodes->item(0)->nodeValue;

        // Split on word boundaries.
        $text = preg_split("@\b@", $text);
        // Kill whitespace and punctuation and stuff.
        $text = array_map(function($word) {
            return preg_replace('@[-=+?.:/;()\'," \s]+@', '', $word);
        }, $text);
        // Kill empty strings.
        $text = array_filter($text);

        $text = implode(' ', $text);

        return $text;
    }

    /**
     * Sampled extracted output from Bitstamp API docs.
     *
     * Last sampled: 2015-8-2.
     *
     * @return string
     *   The sampled HTML from the Bitstamp API docs.
     */
    protected function expectedExtractHash()
    {
        'APIWhat Is API Bitstamp application programming interface API allows our clients to access and control their accounts using custom written software With the inclusion of the new BTC EUR currency pair we ve added new endpoints for some API calls info about specific calls below The old endpoints are still available and have not changed We strongly suggest however that you refer to the v2 API for future references Please note that API v2 endpoints rounding is different than the one used on the old endpoints Request limitsDo not make more than 600 requests per 10 minutes or we will ban your IP address For real time data please refer to the websocket API Public Data FunctionsTickerPassing any GET parameters will result in your request being rejected RequestGEThttps www bitstamp net api ticker returns data for the BTC USD currency pair GEThttps www bitstamp net api v2 ticker btcusd API v2GEThttps www bitstamp net api v2 ticker btceur API v2GEThttps www bitstamp net api v2 ticker eurusd API v2GEThttps www bitstamp net api v2 ticker xrpusd API v2GEThttps www bitstamp net api v2 ticker xrpeur API v2Response JSON lastLast BTC price highLast 24 hours price high lowLast 24 hours price low vwapLast 24 hours volume weighted average price volumeLast 24 hours volume bidHighest buy order askLowest sell order timestampUnix timestamp date and time openFirst price of the day Hourly tickerPassing any GET parameters will result in your request being rejected RequestGEThttps www bitstamp net api ticker_hour returns data for the BTC USD currency pair GEThttps www bitstamp net api v2 ticker_hour btcusd API v2GEThttps www bitstamp net api v2 ticker_hour btceur API v2GEThttps www bitstamp net api v2 ticker_hour eurusd API v2GEThttps www bitstamp net api v2 ticker_hour xrpusd API v2GEThttps www bitstamp net api v2 ticker_hour xrpeur API v2Response JSON Returns a JSON dictionary like the ticker call with the calculated values being from within an hour Order bookPassing any GET parameters will result in your request being rejected RequestGEThttps www bitstamp net api order_book returns data for the BTC USD currency pair GEThttps www bitstamp net api v2 order_book btcusd API v2GEThttps www bitstamp net api v2 order_book btceur API v2GEThttps www bitstamp net api v2 order_book eurusd API v2GEThttps www bitstamp net api v2 order_book xrpusd API v2GEThttps www bitstamp net api v2 order_book xrpeur API v2Response JSON Returns a JSON dictionary with bids and asks Each is a list of open orders and each order is represented as a list holding the price and the amount TransactionsRequestGEThttps www bitstamp net api transactions returns data for the BTC USD currency pair GEThttps www bitstamp net api v2 transactions btcusd API v2GEThttps www bitstamp net api v2 transactions btceur API v2GEThttps www bitstamp net api v2 transactions eurusd API v2GEThttps www bitstamp net api v2 transactions xrpusd API v2GEThttps www bitstamp net api v2 transactions xrpeur API v2Request parameterstime Optional The time interval from which we want the transactions to be returned Possible values are minute hour default or day Response JSON descending list of transactions Every transaction dictionary contains dateUnix timestamp date and time tidTransaction ID priceBTC price amountBTC amount type0 buy or 1 sell EUR USD conversion rateRequestGEThttps www bitstamp net api eur_usd Response JSON buyBuy conversion rate sellSell conversion rate API authenticationAll private API calls require authentication For a successful authentication you need to provide your API key a signature and a nonce parameter API keyTo get an API key go to Account Security and then API Access Set permissions and click Generate key NonceNonce is a regular integer number It must be increased with every request you make Read more about it here Example if you set nonce to 1 in your first request you must set it to at least 2 in your second request You are not required to start with 1 A common practice is to use unix time for that parameter SignatureSignature is a HMAC SHA256 encoded message containing nonce customer ID can be found here and API key The HMAC SHA256 code must be generated using a secret key that was generated with your API key This code must be converted to it s hexadecimal representation 64 uppercase characters A short code example on how to generate a signature can be seen here Python import hmacimport hashlibmessage nonce customer_id api_keysignature hmac new      API_SECRET      msg message      digestmod hashlib sha256 hexdigest upper Authentication errorsAPI key not foundCheck your API key valueIP address not allowedThis IP address has no permission to use this API keyNo permission foundAPI key hasn t got permission for calling this functionInvalid nonceCheck your nonce value It must be greater than last nonce usedInvalid signaturePosted signature doesn t match with oursAuthentication failedCan t find customer with selected API keyMissing key signature and nonce parametersParameters were not posted in API requestYour account is frozenContact support to unfreeze your accountPrivate FunctionsAccount balanceThis API call is cached for 10 seconds This call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api balance POSThttps www bitstamp net api v2 balance API v2POSThttps www bitstamp net api v2 balance btcusd API v2POSThttps www bitstamp net api v2 balance btceur API v2POSThttps www bitstamp net api v2 balance eurusd API v2POSThttps www bitstamp net api v2 balance xrpusd API v2POSThttps www bitstamp net api v2 balance xrpeur API v2Request parameterskeyAPI key signatureSignature nonceNonce Response JSON usd_balanceUSD balance btc_balanceBTC balance eur_balanceEUR balance xrp_balanceXRP balance usd_reservedUSD reserved btc_reservedBTC reserved eur_reservedEUR reserved xrp_reservedXRP reserved usd_availableUSD available for trading btc_availableBTC available for trading eur_availableEUR available for trading xrp_availableXRP available for trading If https www bitstamp net api v2 balance btcusd_feeCustomer BTC USD trading fee btceur_feeCustomer BTC EUR trading fee eurusd_feeCustomer EUR USD trading fee xrpusd_feeCustomer XRP USD trading fee xrpeur_feeCustomer XRP EUR trading fee OtherfeeCustomer trading fee Balance errorsAuthentication errorsUser transactionsThis call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api user_transactions returns all transactions POSThttps www bitstamp net api v2 user_transactions returns all transactions API v2POSThttps www bitstamp net api v2 user_transactions btcusd API v2POSThttps www bitstamp net api v2 user_transactions btceur API v2POSThttps www bitstamp net api v2 user_transactions eurusd API v2POSThttps www bitstamp net api v2 user_transactions xrpusd API v2POSThttps www bitstamp net api v2 user_transactions xrpeur API v2Request parameterskeyAPI key signatureSignature nonceNonce offsetSkip that many transactions before returning results default limitLimit result to that many transactions default 100 maximum 1000 sortSorting by date and time asc ascending desc descending default desc Response JSON success Returns a descending list of transactions represented as dictionaries datetimeDate and time idTransaction ID typeTransaction type deposit 1 withdrawal 2 market trade 14 sub account transfer usdUSD amount eur v2 calls only EUR amount btcBTC amount xrp v2 calls only XRP amount btc_usd or btc_eur if available Exchange rate feeTransaction fee order_idExecuted order ID Response JSON failurestatus v2 calls only error reason v2 calls only The reason for the error User_transactions errorsAuthentication errorsInvalid offsetOffset should be positive numberLimit too largeMax value of limit parameter is 1000Invalid limitLimit parameter should be number from 1 to 1000Invalid sort parameterSort parameter can only be asc or desc Open ordersThis API call is cached for 10 seconds This call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api open_orders returns data for the BTC USD currency pair POSThttps www bitstamp net api v2 open_orders btcusd API v2POSThttps www bitstamp net api v2 open_orders btceur API v2POSThttps www bitstamp net api v2 open_orders eurusd API v2POSThttps www bitstamp net api v2 open_orders xrpusd API v2POSThttps www bitstamp net api v2 open_orders xrpeur API v2Request parameterskeyAPI key signatureSignature nonceNonce Response JSON success Returns a list of open orders where each order is represented as a dictionary idTransaction ID datetimeDate and time type Type buy 1 sell price Price amountAmount Response JSON failurestatus v2 calls only error reason v2 calls only The reason for the error Open_orders errorsAuthentication errorsOrder statusThis call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api order_status Request parameterskeyAPI key signatureSignature nonceNonce idOrder ID Response JSON status In Queue Open or Finished transactionsEach transaction in dictionary is represented as a list of tid usd price fee btc datetime and type deposit 1 withdrawal 2 market trade Order_status errorsAuthentication errorsMissing id POST paramId parameter missingInvalid order idOrder id parameter can only be numberOrder not foundOrder with that id was not found in our systemCancel orderThis call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api cancel_order POSThttps www bitstamp net api v2 cancel_order API v2Request parameterskeyAPI key signatureSignature nonceNonce idOrder ID Response JSON successIf https www bitstamp net api v2 cancel_order idOrder id amountOrder amount priceOrder price typeOrder type If https www bitstamp net api cancel_order True Order has been found and canceled Response JSON failureerrorThe reason for the error Cancel_order errorsAuthentication errorsMissing id POST paramId parameter missingInvalid order idOrder id parameter can only be numberOrder not foundOrder with that id was not found in our systemOrder in queue Please try again later You can only cancel your order when order is in status Open Cancel all ordersThis call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api cancel_all_orders Request parameterskeyAPI key signatureSignature nonceNonce Response JSON This call will cancel all open orders Returns true if all orders have been canceled false if it failed Cancel_all_orders errorsAuthentication errorsBuy limit orderThis call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api buy sets the order for the BTC USD currency pair POSThttps www bitstamp net api v2 buy btcusd API v2POSThttps www bitstamp net api v2 buy btceur API v2POSThttps www bitstamp net api v2 buy eurusd API v2POSThttps www bitstamp net api v2 buy xrpusd API v2POSThttps www bitstamp net api v2 buy xrpeur API v2Request parameterskeyAPI key signatureSignature nonceNonce amountAmount pricePrice limit_priceIf the order gets executed a new sell order will be placed with limit_price as its price daily_order Optional Opens buy limit order which will be canceled at 00 UTC unless it already has been executed Possible value TrueAPI v2Response JSON successidOrder ID datetimeDate and time type0 buy or 1 sell pricePrice amountAmount Response JSON failurestatus v2 calls only error reason v2 calls only The reason for the error Buy errorsAuthentication errorsMissing amount and or price POST parametersMissing one or both parameters parameter Enter a number Use as a decimal point parameter can only be numberMinimum order size is 5 USDOrder value must be at least $ 5Price is more than 20 % above market price Order price must not exceed 20 % of current priceYou need order_value USD to open that order You have only available_fiat USD available Check your account balance for details Account has less available_fiat that are required to make this orderSell if executed price must be higher than buy price limit_price must be larger than price parameterBoth limit_price and daily_order cannot be set Only one of those parameters can be setAPI v2Buy market order By placing a market order you acknowledge that the execution of your order depends on the market conditions and that these conditions may be subject to sudden changes that cannot be foreseen This call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api v2 buy market btcusd API v2POSThttps www bitstamp net api v2 buy market btceur API v2POSThttps www bitstamp net api v2 buy market eurusd API v2POSThttps www bitstamp net api v2 buy market xrpusd API v2POSThttps www bitstamp net api v2 buy market xrpeur API v2Request parameterskeyAPI key signatureSignature nonceNonce amountAmount Response JSON successidOrder ID datetimeDate and time type0 buy or 1 sell pricePrice amountAmount Response JSON failurestatus v2 calls only error reason v2 calls only The reason for the error Market buy errorsAuthentication errorsMissing amount and or price POST parametersMissing one or both parameters parameter Enter a number Use as a decimal point parameter can only be numberMinimum order size is 5 USDOrder value must be at least $ 5You can only buy amount currency Check your account balance for details Account has less available_currency that are required to make this orderSell limit orderThis call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api sell sets the order for the BTC USD currency pair POSThttps www bitstamp net api v2 sell btcusd API v2POSThttps www bitstamp net api v2 sell btceur API v2POSThttps www bitstamp net api v2 sell eurusd API v2POSThttps www bitstamp net api v2 sell xrpusd API v2POSThttps www bitstamp net api v2 sell xrpeur API v2Request parameterskeyAPI key signatureSignature nonceNonce amountAmount pricePrice limit_priceIf the order gets executed a new buy order will be placed with limit_price as its price daily_order Optional Opens sell limit order which will be canceled at 00 UTC unless it already has been executed Possible value TrueAPI v2Response JSON successidOrder ID datetimeDate and time type0 buy or 1 sell pricePrice amountAmount Response JSON failurestatus v2 calls only error reason v2 calls only The reason for the error Sell errorsAuthentication errorsMissing amount and or price POST parametersMissing one or both parameters parameter Enter a number Use as a decimal point parameter can only be numberMinimum order size is $ 5Order value must be at least $ 5Price is more than 20 % below market price Order price must not exceed 20 % of current priceYou have only available_btc BTC available Check your account balance for details Account has less available_btc that are required to make this orderBuy if executed price must be lower than sell price limit_price must be lower than price parameterBoth limit_price and daily_order cannot be set Only one of those parameters can be setAPI v2Sell market order By placing a market order you acknowledge that the execution of your order depends on the market conditions and that these conditions may be subject to sudden changes that cannot be foreseen This call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api v2 sell market btcusd API v2POSThttps www bitstamp net api v2 sell market btceur API v2POSThttps www bitstamp net api v2 sell market eurusd API v2POSThttps www bitstamp net api v2 sell market xrpusd API v2POSThttps www bitstamp net api v2 sell market xrpeur API v2Request parameterskeyAPI key signatureSignature nonceNonce amountAmount Response JSON successidOrder ID datetimeDate and time type0 buy or 1 sell pricePrice amountAmount Response JSON failurestatus v2 calls only error reason v2 calls only The reason for the error Market sell errorsAuthentication errorsMissing amount and or price POST parametersMissing one or both parameters parameter Enter a number Use as a decimal point parameter can only be numberMinimum order size is $ 5Order value must be at least $ 5You can only sell amount currency Check your account balance for details Account has less available_currency that are required to make this orderWithdrawal requestsThis call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api withdrawal_requests Request parameterskeyAPI key signatureSignature nonceNonce timedelta Optional Withdrawal requests from number of seconds ago to now max 50000000 Response JSON idOrder ID datetimeDate and time type0 SEPA 1 bitcoin or 2 WIRE transfer amountAmount status0 open 1 in process 2 finished 3 canceled or 4 failed dataAdditional withdrawal request data addressBitcoin withdrawal address bitcoin withdrawals only transaction_idTransaction id bitcoin withdrawals only Withdrawal_requests errorsAuthentication errorsBitcoin withdrawalThis call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api bitcoin_withdrawal Request parameterskeyAPI key signatureSignature nonceNonce amountBitcoin amount addressBitcoin address instant0 false or 1 true If the destination address supports BitGo Instant deposits and you need instant delivery of Bitcoins with zero confirmations Additional fees apply Response JSON idWithdrawal ID Bitcoin_withdrawal errorsAuthentication errorsMissing amount and or address POST parametersOne or both parameters missingInstant parameter needs to be an integer false or 1 true Instant parameter can only be or 1User not verifiedYou need to verify account before withdrawalBitcoin withdrawals are currently unavailable for your account Contact support for additional information Not allowed to withdraw to specified bitcoin addressAPI key is set for withdrawing to another bitcoin addressEnsure this value is greater than or equal to 00006000Minimum withdrawal amount is 00006Ensure this value has at least 25 characters it has x Ensure this value has at most 34 characters it has x Address parameter must be between 25 and 34 characters longEnter a number Use as a decimal point Amount parameter can only be numberYou have only available BTC available Check your account balance for details Account has less available BTC that are required to make this withdrawalBitcoin deposit addressRequestPOSThttps www bitstamp net api bitcoin_deposit_address Request parameterskeyAPI key signatureSignature nonceNonce Response JSON Returns your bitcoin deposit address Bitcoin_deposit_address errorsAuthentication errorsUnconfirmed bitcoin depositsThis API call is cached for 60 seconds This call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api unconfirmed_btc Request parameterskeyAPI key signatureSignature nonceNonce Response JSON list of unconfirmed bitcoin transactions Each transaction is represented as dictionaryamountBitcoin amount addressDeposit address used confirmationsNumber of confirmations Unconfirmed_btc errorsAuthentication errorsRipple withdrawalThis call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api ripple_withdrawal Request parameterskeyAPI key signatureSignature nonceNonce amountCurrency amount addressBitcoin address currencyCurrency Response JSON Returns true if successful Ripple_withdrawal errorsAuthentication errorsMissing amount and or address and or currency POST parametersOne or all parameters are missingUser not verifiedYou need to verify account before withdrawalRipple withdrawals are currently unavailable for your account Contact support for additional information Ensure this value has at least 25 characters it has x Ensure this value has at most 50 characters it has x Address parameter must be between 25 and 50 characters long parameter Enter a number Use as a decimal point parameter can only be numberYou have only available currency available Check your account balance for details Account has less available currency that are required to make this withdrawalRipple deposit addressThis API call is cached for 60 seconds This call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api ripple_address Request parameterskeyAPI key signatureSignature nonceNonce Response JSON Returns your ripple deposit address Ripple_address errorsAuthentication errorsTransfer balance from Sub to Main accountTransfers the desired balance from a Sub Account to your Main Account Can be called by either the Main Account or a Sub Account but requires a permission in both cases The subAccount parameter must be provided if the Main Account is initiating the call If a Sub Account is making the call then it is the target Sub Account for the transfer and no further clarification is required In that case passing this parameter will have no additional effect RequestPOSThttps www bitstamp net api v2 transfer to main API v2Request parameterskeyAPI key signatureSignature nonceNonce amountAmount currencyCurrency subAccount Optional The Sub Account unique identifier Response JSON status ok or error reason available only if status is error Additional error info Transfer to main errorsAuthentication errors parameter Enter a number Use as a decimal point parameter can only be numberYou have only available currency available Check your account balance for details Account has less available currency that are required to make this transferSelect a valid choice X is not one of the available choices X is not valid currency Possible choices BTC USD EUR XRP Sub account with identifier X does not exist Can t find sub account with id X Transfer balance from Main to Sub AccountTransfers the desired balance from your Main Account to a Sub Account specified by the subAccount parameter This call can only be performed by your Main Account RequestPOSThttps www bitstamp net api v2 transfer from main API v2Request parameterskeyAPI key signatureSignature nonceNonce amountAmount currencyCurrency subAccountThe Sub Account unique identifier Response JSON status ok or error reason available only if status is error Additional error info Transfer from main errorsAuthentication errors parameter Enter a number Use as a decimal point parameter can only be numberYou have only available currency available Check your account balance for details Account has less available currency that are required to make this transferSelect a valid choice X is not one of the available choices X is not valid currency Possible choices BTC USD EUR XRP Sub account with identifier X does not exist Can t find sub account with id X XRP withdrawalThis call will be executed on the account Sub or Main to which the used API key is bound to RequestPOSThttps www bitstamp net api v2 xrp_withdrawal API v2Request parameterskeyAPI key signatureSignature nonceNonce amountXRP amount addressXRP address destination_tag Optional Address destination tag Response JSON idWithdrawal ID XRP_withdrawal errorsAuthentication errorsMissing amount and or address POST parametersOne or both parameters missingXRP withdrawals are currently unavailable for your account Contact support for additional information Not allowed to withdraw to specified XRP addressAPI key is set for withdrawing to another XRP addressEnsure this value is greater than or equal to 20Minimum withdrawal amount is 20Ensure this value has at least 25 characters it has x Ensure this value has at most 34 characters it has x Address parameter must be between 25 and 34 characters longEnter a number Use as a decimal point Amount parameter can only be numberYou have only available XRP available Check your account balance for details Account has less available XRP that are required to make this withdrawal';

        return '4baea42912ce53e9bbd7c6579c9692b4';
    }
}
